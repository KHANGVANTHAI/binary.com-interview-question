---
title: "<img src='https://raw.githubusercontent.com/englianhu/binary.com-interview-question/757b27e1e93132368b0898152078be4961b05a28/www/binary-logo-resize.jpg' width='240'>"
subtitle: "[<span style='color:blue'>binary.com</span>](https://github.com/englianhu/binary.com-interview-question) Interview Question I - Application of Kelly Betting on Tick-Data-History"
author: "[<span style='color:blue'>®γσ, Lian Hu</span>](https://englianhu.github.io/) <img src='https://raw.githubusercontent.com/englianhu/binary.com-interview-question/master/www/ENG.jpg' width='24'> <img src='https://raw.githubusercontent.com/englianhu/binary.com-interview-question/master/www/RYO.jpg?raw=true' width='24'>®"
date: "`r today('Asia/Tokyo')`"
output:
  tufte::tufte_html:
    toc: yes
    toc_depth: 4
    self_contained: no
    number_sections: true
  tufte::tufte_book:
    citation_package: natbib
    latex_engine: xelatex
  tufte::tufte_handout:
    citation_package: natbib
    latex_engine: xelatex
link-citations: yes
---

```{r setup, include = FALSE}
suppressPackageStartupMessages(library('BBmisc'))
pkgs <- c('knitr', 'kableExtra', 'tint', 'devtools', 'lubridate', 'plyr', 'stringr', 'magrittr', 'dplyr', 'tidyr', 'tidyverse', 'tidyquant', 'turner', 'readr', 'quantmod', 'htmltools', 'highcharter', 'googleVis', 'formattable', 'ggfortify', 'DT', 'forecast', 'PerformanceAnalytics', 'broom', 'microbenchmark', 'doParallel', 'Boruta', 'fBasics', 'fPortfolio', 'rugarch', 'parma', 'rmgarch')

suppressAll(lib(pkgs))

#'@ suppressAll(l_ply(c('last.R', 'Mn.R', 'has.Mn.R', 'simAutoArima.R', 'simStakesAutoArima.R', 'simETS.R', 'simStakesETS.R', 'plotChart2.R', 'armaSearch.R', 'simGarch.R', 'simStakesGarch.R'), function(pkg) source(paste0('./function/', pkg))))

## Set option to below if you want to plot an independent webpage with graph 
#'@ op <- options(gvis.plot.tag=NULL)
op <- options(gvis.plot.tag = 'chart')
options(gvis.plot.tag = 'chart', warn = -1)
#'@ options(rpubs.upload.method = 'internal')

## R: llply fully reproducible results in parallel
## https://stackoverflow.com/questions/34946177/r-llply-fully-reproducible-results-in-parallel
cl <- makeCluster(detectCores())
registerDoParallel(cl)

# Create a cluster object to be used for rugarcgh and rmgarch models.
#'@ cluster = makePSOCKcluster(15)
suppressPackageStartupMessages(library('BBmisc'))
pkgs <- c('knitr', 'kableExtra', 'tint', 'devtools', 'lubridate', 'plyr', 'stringr', 'magrittr', 'dplyr', 'tidyr', 'data.table', 'tidyverse', 'tidyquant', 'turner', 'readr', 'R.utils', 'quantmod', 'htmltools', 'highcharter', 'googleVis', 'formattable', 'ggfortify', 'DT', 'forecast', 'PerformanceAnalytics', 'broom', 'microbenchmark', 'doParallel', 'Boruta', 'fBasics', 'fPortfolio', 'rugarch', 'parma', 'rmgarch')

suppressAll(lib(pkgs))

#'@ suppressAll(l_ply(c('last.R', 'Mn.R', 'has.Mn.R', 'simAutoArima.R', 'simStakesAutoArima.R', 'simETS.R', 'simStakesETS.R', 'plotChart2.R', 'armaSearch.R', 'simGarch.R', 'simStakesGarch.R'), function(pkg) source(paste0('./function/', pkg))))

# invalidate cache when the package version changes
#'@ knitr::opts_chunk$set(tidy = FALSE, cache.extra = packageVersion('tint'))
rm(pkgs)
#'@ options(htmltools.dir.version = FALSE)
```

# 1. Introduction

  In order to test the timeline of daily highest and lowest price, here I created this file to read the high volume tick-data-history to test the efficiency of Kelly Criterion betting models. Kindly refer to [Reference] for further information.

# 2. Data

## 2.1 Read Data

  I use more than 3 years data (from week 1 2015 until week 27 2018)^[You are feel feel to get the data via [FXCMTickData](https://github.com/fxcm/FXCMTickData)] for the question as experiment, 1st year data is burn-in data for statistical modelling and prediction purpose while following 2 years data for forecasting and staking. There have 52 trading weeks within a year.

```{r read-data, echo = FALSE, eval = FALSE}
## ================== eval = FALSE =============================
## Do not execute...
## 
## Remove all objects include hidden objects.
#'@ rm(list = ls(all.names = TRUE))

library('plyr')
library('dplyr')
library('purrr')
library('readr')
library('magrittr')
library('lubridate')
library('data.table')
library('R.utils')

## get currency dataset online.
yr <- c(2015, 2016, 2017, 2018)
wk <- 1:53

## https://www.epochconverter.com/years
llply(yr, function(i) {
  if(i == 2015|i == 2017) wk <- 1:53 else wk <- 1:52
  llply(wk, function(j) {
    lnk <- paste0(
      'https://tickdata.fxcorporate.com/USDJPY/', i, '/', j, '.csv.gz')
    if(!dir.exists('data/tickdata')) dir.create('data/tickdata')
    if(!file.exists(paste0('data/tickdata/Y', i, 'W', j, '.csv.gz'))) {
      download.file(lnk, destfile = paste0(
        'data/tickdata/Y', i, 'W', j, '.csv.gz'))
      #cat(paste0('data/tickdata/Y', i, 'W', j, '.csv.gz downloaded!\n'))
    }
  })
})

llply(yr, function(i) {
  if(i == 2015|i == 2017) wk <- 1:53 else wk <- 1:52
  llply(wk, function(j) {
    if(file.exists(paste0('data/tickdata/Y', i, 'W', j, '.csv.gz')) & 
       !file.exists(paste0('data/tickdata/Y', i, 'W', j, '.csv'))) {
      R.utils::gunzip(paste0('data/tickdata/Y', i, 'W', j, '.csv.gz'), 
                      remove = FALSE)
      cat(paste0('data/tickdata/Y', i, 'W', j, '.csv.gz extracted!\n'))
    }
  })
})

## remove all files size less than 1MB
if(any(file.exists(paste0(
  'data/tickdata/', dir('data/tickdata', pattern = '.csv')[file.size(paste0(
    'data/tickdata/', dir('data/tickdata', pattern = '.csv'))) <= 1000000])))) {
  file.remove(paste0(
    'data/tickdata/', dir('data/tickdata', pattern = '.csv')[file.size(paste0(
      'data/tickdata/', dir('data/tickdata', pattern = '.csv'))) <= 1000000]))
  }





### ----------------------------------------

## https://stackoverflow.com/questions/43642708/fread-with-gunzip-whats-the-more-memory-efficient-way/43643513
## https://stackoverflow.com/questions/37727865/how-can-i-use-fread-to-read-gz-files-in-r?noredirect=1&lq=1
#'@ data.table::fread("gunzip -c data/tickdata/Y2015W1.csv.gz")

l_ply(dir('data/tickdata', pattern = '.csv$'), function(x) file.remove(paste0('data/tickdata/', x)))

for(i in yr){
    for(j in wk) {
        assign(paste0('Y', i, 'W', j), data.table::fread(paste0('data/tickdata/Y', i, 'W', j, '.csv')))
    }
}



#'@ USDJPY <- readRDS('./data/USDJPY.rds')
USDJPY <- xts(USDJPY[, -1], order.by = USDJPY$Date)

## dateID
dateID <- index(mbase)
dateID0 <- ymd('2015-01-01')
dateID <- dateID[dateID > dateID0]
obs.data <- USDJPY[index(USDJPY) > dateID0]

## Now we try to use the daily mean value which is (Hi + Lo) / 2.
pred.data <- ldply(dateID, function(dt) {
  smp = USDJPY
  dtr = last(index(smp[index(smp) < dt]))
  smp = smp[paste0(dtr %m-% years(1), '/', dtr)]
  frd = as.numeric(difftime(dt, dtr), units = 'days')
  fit = ets(smp) #https://www.otexts.org/fpp/7/7
  data.frame(Date = dt, forecast(fit, h = frd)) %>% tbl_df
  }, .parallel = FALSE) %>% tbl_df

cmp.data <- xts(pred.data[, -1], order.by = pred.data$Date)
cmp.data <- cbind(cmp.data, obs.data)
rm(obs.data, pred.data)

# Test the models
lm(Point.Forecast~ USD.JPY, data = cmp.data)
MCMCregress(Point.Forecast~ USD.JPY, data = cmp.data)

plot(forecast(fit))
forecast(fit, h = 4)
```

```{r read-data2, warning = FALSE}
## get currency dataset online.
## http://stackoverflow.com/questions/24219694/get-symbols-quantmod-ohlc-currency-data
#'@ getFX('USD/JPY', from = '2014-01-01', to = '2017-01-20')

## getFX() doesn't shows Op, Hi, Lo, Cl price but only price. Therefore no idea to place bets.
#'@ USDJPY <- getSymbols('JPY=X', src = 'yahoo', from = '2014-01-01', 
#'@                      to = '2017-01-20', auto.assign = FALSE)
#'@ names(USDJPY) <- str_replace_all(names(USDJPY), 'JPY=X', 'USDJPY')
#'@ USDJPY <- xts(USDJPY[, -1], order.by = USDJPY$Date)

#'@ saveRDS(USDJPY, './data/USDJPY.rds')
USDJPY <- read_rds(path = './data/USDJPY.rds')
mbase <- USDJPY

## dateID
dateID <- index(mbase)
dateID0 <- ymd('2015-01-01')
dateID <- dateID[dateID > dateID0]
```

```{r data-summary}
dim(mbase)
summary(mbase) %>% kable(width = 'auto')
```

## 2.2 Tidy Data

#### 2.1.2.1 ARIMA vs ETS
  
  <span style='color:red'>**Remarks :** *Here I try to predict the sell/buy price and also settled price. However just noticed the question asking about prediction of the variance^[The profit is made based on the range of variance Hi-Lo price but not the accuracy of the highest, lowest or closing price.] based on mean price. I can also use the focasted highest and forecasted lowest price for variance prediction as well. However I will conduct another study and answer for the variance with Garch models.*</span>

  Below are some articles with regards exponential smoothing.
  
 - [<span style='color:blue'>Recent Advances in Robust Statistics: Theory and Applications</span>](https://books.google.com.my/books?id=ntR5DQAAQBAJ&pg=PA174&lpg=PA174&dq=exponential+smoothing+mcmc&source=bl&ots=QANf4o9oFh&sig=JWov-64qeFTcOScG2pYj9OVCl2k&hl=ja&sa=X&redir_esc=y#v=onepage&q=exponential%20smoothing%20mcmc&f=false)
 - [<span style='color:blue'>Error, trend, seasonality - ets and its forecast model friends</span>](http://ellisp.github.io/blog/2016/11/27/ets-friends)
 - [<span style='color:blue'>A study of outliers in the exponential smoothing approach to forecasting</span>](https://www.statindex.org/articles/258660)
 - [<span style='color:blue'>8.10 ARIMA vs ETS</span>](https://www.otexts.org/fpp/8/10)
 - [<span style='color:blue'>Introduction to ARIMA : nonseasonal models</span>](http://people.duke.edu/~rnau/411arim.htm#les)

  It is a common myth that ARIMA models are more general than exponential smoothing. While linear exponential smoothing models are all special cases of ARIMA models, the non-linear exponential smoothing models have no equivalent ARIMA counterparts. There are also many ARIMA models that have no exponential smoothing counterparts. In particular, every ETS model^[[<span style='color:blue'>**forecast::ets()**</span>](https://www.rdocumentation.org/packages/forecast/versions/7.3/topics/ets) : Usually a three-character string identifying method using the framework terminology of Hyndman et al. (2002) and Hyndman et al. (2008). The first letter denotes the error type ("A", "M" or "Z"); the second letter denotes the trend type ("N","A","M" or "Z"); and the third letter denotes the season type ("N","A","M" or "Z"). In all cases, "N"=none, "A"=additive, "M"=multiplicative and "Z"=automatically selected. So, for example, "ANN" is simple exponential smoothing with additive errors, "MAM" is multiplicative Holt-Winters' method with multiplicative errors, and so on.
It is also possible for the model to be of class "ets", and equal to the output from a previous call to ets. In this case, the same model is fitted to y without re-estimating any smoothing parameters. See also the use.initial.values argument.] is non-stationary, while ARIMA models can be stationary.

  The ETS models with seasonality or non-damped trend or both have two unit roots (i.e., they need two levels of differencing to make them stationary). All other ETS models have one unit root (they need one level of differencing to make them stationary).

  The following table gives some equivalence relationships for the two classes of models.

  | ETS model	          | ARIMA model	                          | Parameters                    |
  |:-------------------:|:-------------------------------------:|:-----------------------------:|
  | $ETS(A, N, N)$	    | $ARIMA(0, 1, 1)$	                    | $θ_{1} = α − 1$               |
  | $ETS(A, A, N)$	    | $ARIMA(0, 2, 2)$	                    | $θ_{1} = α + β − 2$           |
  |                     |                                       | $θ_{2} = 1 − α$               |
  | $ETS(A, A_{d}, N)$	| $ARIMA(1, 1, 2)$	                    | $ϕ_{1} = ϕ$                   |
  |                     |                                       | $θ_{1} = α + ϕβ − 1 −  ϕ$     |
  |                     |                                       | $θ_{2} = (1 − α)ϕ$            |
  | $ETS(A, N, A)$	    | $ARIMA(0, 0, m)(0, 1, 0)_{m}$	        |                               |
  | $ETS(A, A, A)$	    | $ARIMA(0, 1, m+1)(0, 1, 0)_{m}$	      |                               |
  | $ETS(A, A_{d}, A)$	| $ARIMA(1, 0, m+1)(0, 1, 0)_{m}$	      |                               |

  For the seasonal models, there are a large number of restrictions on the ARIMA parameters.

  Kindly refer to [<span style='color:blue'>*8.10 ARIMA vs ETS*</span>](https://www.otexts.org/fpp/8/10) for further details.

```{r build-AutoArima}
## Modelling Auto Arima focasting data.
#'@ fitAutoArima.op <- suppressAll(simAutoArima(USDJPY, .prCat = 'Op')) #will take a minute
#'@ saveRDS(fitAutoArima.op, './data/fitAutoArima.op.rds')

#'@ fitAutoArima.hi <- suppressAll(simAutoArima(USDJPY, .prCat = 'Hi')) #will take a minute
#'@ saveRDS(fitAutoArima.hi, './data/fitAutoArima.hi.rds')

#'@ fitAutoArima.mn <- suppressAll(simAutoArima(USDJPY, .prCat = 'Mn')) #will take a minute
#'@ saveRDS(fitAutoArima.mn, './data/fitAutoArima.mn.rds')

#'@ fitAutoArima.lo <- suppressAll(simAutoArima(USDJPY, .prCat = 'Lo')) #will take a minute
#'@ saveRDS(fitAutoArima.lo, './data/fitAutoArima.lo.rds')

#'@ fitAutoArima.cl <- suppressAll(simAutoArima(USDJPY, .prCat = 'Cl')) #will take a minute
#'@ saveRDS(fitAutoArima.cl, './data/fitAutoArima.cl.rds')

fitAutoArima.op <- readRDS('./data/fitAutoArima.op.rds')
fitAutoArima.hi <- readRDS('./data/fitAutoArima.hi.rds')
fitAutoArima.mn <- readRDS('./data/fitAutoArima.mn.rds')
fitAutoArima.lo <- readRDS('./data/fitAutoArima.lo.rds')
fitAutoArima.cl <- readRDS('./data/fitAutoArima.cl.rds')
```

```{r build-ETS}
## Modelling ETS focasting data.
#'@ fitETS.op <- suppressAll(simETS(USDJPY, .prCat = 'Op')) #will take a minute
#'@ saveRDS(fitETS.op, './data/fitETS.op.rds')

#'@ fitETS.hi <- suppressAll(simETS(USDJPY, .prCat = 'Hi')) #will take a minute
#'@ saveRDS(fitETS.hi, './data/fitETS.hi.rds')

#'@ fitETS.mn <- suppressAll(simETS(USDJPY, .prCat = 'Mn')) #will take a minute
#'@ saveRDS(fitETS.mn, './data/fitETS.mn.rds')

#'@ fitETS.lo <- suppressAll(simETS(USDJPY, .prCat = 'Lo')) #will take a minute
#'@ saveRDS(fitETS.lo, './data/fitETS.lo.rds')

#'@ fitETS.cl <- suppressAll(simETS(USDJPY, .prCat = 'Cl')) #will take a minute
#'@ saveRDS(fitETS.cl, './data/fitETS.cl.rds')

fitETS.op <- readRDS('./data/fitETS.op.rds')
fitETS.hi <- readRDS('./data/fitETS.hi.rds')
fitETS.mn <- readRDS('./data/fitETS.mn.rds')
fitETS.lo <- readRDS('./data/fitETS.lo.rds')
fitETS.cl <- readRDS('./data/fitETS.cl.rds')
```

```{r lm-ETS, warning = FALSE}
## Here I test the accuracy of forecasting of ets ZZZ model 1.

## Test the models
## opened price fit data
summary(lm(Point.Forecast~ USDJPY.Close, data = fitETS.op))
summary(MCMCregress(Point.Forecast~ USDJPY.Close, data = fitETS.op))

## highest price fit data
summary(lm(Point.Forecast~ USDJPY.Close, data = fitETS.hi))
summary(MCMCregress(Point.Forecast~ USDJPY.Close, data = fitETS.hi))

## mean price fit data (mean price of daily highest and lowest price)
summary(lm(Point.Forecast~ USDJPY.Close, data = fitETS.mn))
summary(MCMCregress(Point.Forecast~ USDJPY.Close, data = fitETS.mn))

## lowest price fit data
summary(lm(Point.Forecast~ USDJPY.Close, data = fitETS.lo))
summary(MCMCregress(Point.Forecast~ USDJPY.Close, data = fitETS.lo))

## closed price fit data
summary(lm(Point.Forecast~ USDJPY.Close, data = fitETS.cl))
summary(MCMCregress(Point.Forecast~ USDJPY.Close, data = fitETS.cl))
```

**Mean Squared Error**

```{r combine-dataAutoArima}
fcdataAA <- do.call(cbind, list(USDJPY.FPOP.Open = fitAutoArima.op$Point.Forecast, 
                              USDJPY.FPHI.High = fitAutoArima.hi$Point.Forecast, 
                              USDJPY.FPMN.Mean = fitAutoArima.mn$Point.Forecast, 
                              USDJPY.FPLO.Low = fitAutoArima.lo$Point.Forecast, 
                              USDJPY.FPCL.Close = fitAutoArima.cl$Point.Forecast, 
                              USDJPY.Open = fitAutoArima.op$USDJPY.Open, 
                              USDJPY.High = fitAutoArima.op$USDJPY.High, 
                              USDJPY.Low = fitAutoArima.op$USDJPY.Low, 
                              USDJPY.Close = fitAutoArima.op$USDJPY.Close))
fcdataAA <- na.omit(fcdataAA)
names(fcdataAA) <- c('USDJPY.FPOP.Open', 'USDJPY.FPHI.High', 'USDJPY.FPMN.Mean', 
                   'USDJPY.FPLO.Low', 'USDJPY.FPCL.Close', 'USDJPY.Open', 
                   'USDJPY.High', 'USDJPY.Low', 'USDJPY.Close')

## Mean Squared Error : comparison of accuracy
paste('Open = ', mean((fcdataAA$USDJPY.FPOP.Open - fcdataAA$USDJPY.Open)^2))
paste('High = ', mean((fcdataAA$USDJPY.FPHI.High - fcdataAA$USDJPY.High)^2))
paste('Mean = ', mean((fcdataAA$USDJPY.FPMN.Mean - (fcdataAA$USDJPY.High + fcdataAA$USDJPY.Low)/2)^2))
paste('Low = ', mean((fcdataAA$USDJPY.FPLO.Low - fcdataAA$USDJPY.Low)^2))
paste('Close = ', mean((fcdataAA$USDJPY.FPCL.Close - fcdataAA$USDJPY.Close)^2))
```

```{r combine-dataETS}
fcdata <- do.call(cbind, list(USDJPY.FPOP.Open = fitETS.op$Point.Forecast, 
                              USDJPY.FPHI.High = fitETS.hi$Point.Forecast, 
                              USDJPY.FPMN.Mean = fitETS.mn$Point.Forecast, 
                              USDJPY.FPLO.Low = fitETS.lo$Point.Forecast, 
                              USDJPY.FPCL.Close = fitETS.cl$Point.Forecast, 
                              USDJPY.Open = fitETS.op$USDJPY.Open, 
                              USDJPY.High = fitETS.op$USDJPY.High, 
                              USDJPY.Low = fitETS.op$USDJPY.Low, 
                              USDJPY.Close = fitETS.op$USDJPY.Close))
fcdata <- na.omit(fcdata)
names(fcdata) <- c('USDJPY.FPOP.Open', 'USDJPY.FPHI.High', 'USDJPY.FPMN.Mean', 
                   'USDJPY.FPLO.Low', 'USDJPY.FPCL.Close', 'USDJPY.Open', 
                   'USDJPY.High', 'USDJPY.Low', 'USDJPY.Close')

## Mean Squared Error : comparison of accuracy
paste('Open = ', mean((fcdata$USDJPY.FPOP.Open - fcdata$USDJPY.Open)^2))
paste('High = ', mean((fcdata$USDJPY.FPHI.High - fcdata$USDJPY.High)^2))
paste('Mean = ', mean((fcdata$USDJPY.FPMN.Mean - (fcdata$USDJPY.High + fcdata$USDJPY.Low)/2)^2))
paste('Low = ', mean((fcdata$USDJPY.FPLO.Low - fcdata$USDJPY.Low)^2))
paste('Close = ', mean((fcdata$USDJPY.FPCL.Close - fcdata$USDJPY.Close)^2))
```

## 2.3 Data Visualization


```{r plotETS-2, echo = FALSE}
#'@ source('./function/plotChart2.R', local = TRUE)
suppressAll(rm(fitETS.op, fitETS.hi, fitETS.mn, fitETS.lo, fitETS.cl))

plotChart2(fcdata, initialName = 'FP', chart.type = 'FP', graph.title = 'ETS Model : USDJPY')
```

# 3. Betting Strategy

# 4. Return of Investment

```{r simStaking-AutoArima, eval = FALSE, include = FALSE}
##============================ EVAL = FALSE ================================
## 
## Model 1 without leverage.
## 
## Placed orders - Fund size without log

#'@ mbase <- USDJPY

## settled with highest price.
fundAutoArimaOPHI <- simStakesAutoArima(mbase, .prCat = 'Op', .setPrice = 'Hi', .initialFundSize = 1000)
saveRDS(fundAutoArimaOPHI, file = './data/fundAutoArimaOPHI.rds')

fundAutoArimaHIHI <- simStakesAutoArima(mbase, .prCat = 'Hi', .setPrice = 'Hi', .initialFundSize = 1000)
saveRDS(fundAutoArimaHIHI, file = './data/fundAutoArimaHIHI.rds')

fundAutoArimaMNHI <- simStakesAutoArima(mbase, .prCat = 'Mn', .setPrice = 'Hi', .initialFundSize = 1000)
saveRDS(fundAutoArimaMNHI, file = './data/fundAutoArimaMNHI.rds')

fundAutoArimaLOHI <- simStakesAutoArima(mbase, .prCat = 'Lo', .setPrice = 'Hi', .initialFundSize = 1000)
saveRDS(fundAutoArimaLOHI, file = './data/fundAutoArimaLOHI.rds')

fundAutoArimaCLHI <- simStakesAutoArima(mbase, .prCat = 'Cl', .setPrice = 'Hi', .initialFundSize = 1000)
saveRDS(fundAutoArimaCLHI, file = './data/fundAutoArimaCLHI.rds')


## settled with mean price.
fundAutoArimaOPMN <- simStakesAutoArima(mbase, .prCat = 'Op', .setPrice = 'Mn', .initialFundSize = 1000)
saveRDS(fundAutoArimaOPMN, file = './data/fundAutoArimaOPMN.rds')

fundAutoArimaHIMN <- simStakesAutoArima(mbase, .prCat = 'Hi', .setPrice = 'Mn', .initialFundSize = 1000)
saveRDS(fundAutoArimaHIMN, file = './data/fundAutoArimaHIMN.rds')

fundAutoArimaMNMN <- simStakesAutoArima(mbase, .prCat = 'Mn', .setPrice = 'Mn', .initialFundSize = 1000)
saveRDS(fundAutoArimaMNMN, file = './data/fundAutoArimaMNMN.rds')

fundAutoArimaLOMN <- simStakesAutoArima(mbase, .prCat = 'Lo', .setPrice = 'Mn', .initialFundSize = 1000)
saveRDS(fundAutoArimaLOMN, file = './data/fundAutoArimaLOMN.rds')

fundAutoArimaCLMN <- simStakesAutoArima(mbase, .prCat = 'Cl', .setPrice = 'Mn', .initialFundSize = 1000)
saveRDS(fundAutoArimaCLMN, file = './data/fundAutoArimaCLMN.rds')


## settled with opening price.
fundAutoArimaOPLO <- simStakesAutoArima(mbase, .prCat = 'Op', .setPrice = 'Lo', .initialFundSize = 1000)
saveRDS(fundAutoArimaOPLO, file = './data/fundAutoArimaOPLO.rds')

fundAutoArimaHILO <- simStakesAutoArima(mbase, .prCat = 'Hi', .setPrice = 'Lo', .initialFundSize = 1000)
saveRDS(fundAutoArimaHILO, file = './data/fundAutoArimaHILO.rds')

fundAutoArimaMNLO <- simStakesAutoArima(mbase, .prCat = 'Mn', .setPrice = 'Lo', .initialFundSize = 1000)
saveRDS(fundAutoArimaMNLO, file = './data/fundAutoArimaMNLO.rds')

fundAutoArimaLOLO <- simStakesAutoArima(mbase, .prCat = 'Lo', .setPrice = 'Lo', .initialFundSize = 1000)
saveRDS(fundAutoArimaLOLO, file = './data/fundAutoArimaLOLO.rds')

fundAutoArimaCLLO <- simStakesAutoArima(mbase, .prCat = 'Cl', .setPrice = 'Lo', .initialFundSize = 1000)
saveRDS(fundAutoArimaCLLO, file = './data/fundAutoArimaCLLO.rds')


## settled with closing price.
fundAutoArimaOPCL <- simStakesAutoArima(mbase, .prCat = 'Op', .setPrice = 'Cl', .initialFundSize = 1000)
saveRDS(fundAutoArimaOPCL, file = './data/fundAutoArimaOPCL.rds')

fundAutoArimaHICL <- simStakesAutoArima(mbase, .prCat = 'Hi', .setPrice = 'Cl', .initialFundSize = 1000)
saveRDS(fundAutoArimaHICL, file = './data/fundAutoArimaHICL.rds')

fundAutoArimaMNCL <- simStakesAutoArima(mbase, .prCat = 'Mn', .setPrice = 'Cl', .initialFundSize = 1000)
saveRDS(fundAutoArimaMNCL, file = './data/fundAutoArimaMNCL.rds')

fundAutoArimaLOCL <- simStakesAutoArima(mbase, .prCat = 'Lo', .setPrice = 'Cl', .initialFundSize = 1000)
saveRDS(fundAutoArimaLOCL, file = './data/fundAutoArimaLOCL.rds')

fundAutoArimaCLCL <- simStakesAutoArima(mbase, .prCat = 'Cl', .setPrice = 'Cl', .initialFundSize = 1000)
saveRDS(fundAutoArimaCLCL, file = './data/fundAutoArimaCLCL.rds')

## Placed orders - Fund size without log
fundList <- list(fundOPHI = fundAutoArimaOPHI, fundHIHI = fundAutoArimaHIHI, fundMNHI = fundAutoArimaMNHI, fundLOHI = fundAutoArimaLOHI, fundCLHI = fundAutoArimaCLHI, 
                fundOPMN = fundAutoArimaOPMN, fundHIMN = fundAutoArimaHIMN, fundMNMN = fundAutoArimaMNMN, fundLOMN = fundAutoArimaLOMN, fundCLMN = fundAutoArimaCLMN, 
                fundOPLO = fundAutoArimaOPLO, fundHILO = fundAutoArimaHILO, fundMNLO = fundAutoArimaMNLO, fundLOLO = fundAutoArimaLOLO, fundCLLO = fundAutoArimaCLLO, 
                fundOPCL = fundAutoArimaOPCL, fundHICL = fundAutoArimaHICL, fundMNCL = fundAutoArimaMNCL, fundLOCL = fundAutoArimaLOCL, fundCLCL = fundAutoArimaCLCL)

ldply(fundList, function(x) { x %>% mutate(StartDate = first(Date), LatestDate = last(Date), InitFund = first(BR), LatestFund = last(Bal), Profit = sum(Profit), RR = LatestFund/InitFund) %>% dplyr::select(StartDate, LatestDate, InitFund, LatestFund, Profit, RR) %>% unique }) %>% tbl_df
# A tibble: 20 x 7
#         .id  StartDate LatestDate InitFund LatestFund    Profit       RR
#       <chr>     <date>     <date>    <dbl>      <dbl>     <dbl>    <dbl>
#  1 fundOPHI 2015-01-02 2017-01-20     1000   1325.983 325.98313 1.325983
#  2 fundHIHI 2015-01-02 2017-01-20     1000   1000.000   0.00000 1.000000
#  3 fundMNHI 2015-01-02 2017-01-20     1000   1236.199 236.19900 1.236199
#  4 fundLOHI 2015-01-02 2017-01-20     1000   1716.985 716.98492 1.716985
#  5 fundCLHI 2015-01-02 2017-01-20     1000   1323.688 323.68809 1.323688
#  6 fundOPMN 2015-01-02 2017-01-20     1000   1304.819 304.81916 1.304819
#  7 fundHIMN 2015-01-02 2017-01-20     1000   1363.714 363.71443 1.363714
#  8 fundMNMN 2015-01-02 2017-01-20     1000   1000.000   0.00000 1.000000
#  9 fundLOMN 2015-01-02 2017-01-20     1000   1440.170 440.16965 1.440170
# 10 fundCLMN 2015-01-02 2017-01-20     1000   1292.947 292.94694 1.292947
# 11 fundOPLO 2015-01-02 2017-01-20     1000   1307.610 307.60951 1.307610
# 12 fundHILO 2015-01-02 2017-01-20     1000   1637.251 637.25113 1.637251
# 13 fundMNLO 2015-01-02 2017-01-20     1000   1250.375 250.37547 1.250375
# 14 fundLOLO 2015-01-02 2017-01-20     1000   1000.000   0.00000 1.000000
# 15 fundCLLO 2015-01-02 2017-01-20     1000   1261.157 261.15684 1.261157
# 16 fundOPCL 2015-01-02 2017-01-20     1000   1047.563  47.56281 1.047563
# 17 fundHICL 2015-01-02 2017-01-20     1000   1401.694 401.69378 1.401694
# 18 fundMNCL 2015-01-02 2017-01-20     1000   1158.790 158.79028 1.158790
# 19 fundLOCL 2015-01-02 2017-01-20     1000   1499.818 499.81773 1.499818
# 20 fundCLCL 2015-01-02 2017-01-20     1000   1000.000   0.00000 1.000000
```

```{r ROI-AutoArima, echo = FALSE}
## load the pre-run and saved models.
## Profit and Loss of Arima models.

flsAutoArima <- dir('./data', pattern = 'fundAutoArima')

fundList <- llply(flsAutoArima, function(dt) {
    cbind(Model = str_replace_all(dt, '.rds', ''), 
          readRDS(file = paste0('./data/', dt))) %>% tbl_df
  })
names(fundList) <- sapply(fundList, function(x) xts::first(x$Model))

## Summary of ROI
aa.tbl <- ldply(fundList, function(x) { x %>% mutate(StartDate = xts::first(Date), LatestDate = last(Date), InitFund = xts::first(BR), LatestFund = last(Bal), Profit = sum(Profit), RR = LatestFund/InitFund) %>% dplyr::select(StartDate, LatestDate, InitFund, LatestFund, Profit, RR) %>% unique }) %>% tbl_df

aa.tbl %>% kable(width = 'auto')
```

  The return of investment from best fitted Auto Arima model.

```
 7 fundAutoArimaHILO 2015-01-02 2017-01-20     1000   1637.251 637.25113 1.637251
10 fundAutoArimaLOHI 2015-01-02 2017-01-20     1000   1716.985 716.98492 1.716985
```

  Profit and Loss of default `ZZZ` ets models.

```{r simStaking-woutLog, warning = FALSE}
## 
## Model 1 without leverage.
## 
## Placed orders - Fund size without log

#'@ mbase <- USDJPY

## settled with highest price.
#'@ fundOPHI <- simStakesETS(mbase, .prCat = 'Op', .setPrice = 'Hi', .initialFundSize = 1000)
#'@ saveRDS(fundOPHI, file = './data/fundOPHI.rds')

#'@ fundHIHI <- simStakesETS(mbase, .prCat = 'Hi', .setPrice = 'Hi', .initialFundSize = 1000)
#'@ saveRDS(fundHIHI, file = './data/fundHIHI.rds')

#'@ fundMNHI <- simStakesETS(mbase, .prCat = 'Mn', .setPrice = 'Hi', .initialFundSize = 1000)
#'@ saveRDS(fundMNHI, file = './data/fundMNHI.rds')

#'@ fundLOHI <- simStakesETS(mbase, .prCat = 'Lo', .setPrice = 'Hi', .initialFundSize = 1000)
#'@ saveRDS(fundLOHI, file = './data/fundLOHI.rds')

#'@ fundCLHI <- simStakesETS(mbase, .prCat = 'Cl', .setPrice = 'Hi', .initialFundSize = 1000)
#'@ saveRDS(fundCLHI, file = './data/fundCLHI.rds')


## settled with mean price.
#'@ fundOPMN <- simStakesETS(mbase, .prCat = 'Op', .setPrice = 'Mn', .initialFundSize = 1000)
#'@ saveRDS(fundOPMN, file = './data/fundOPMN.rds')

#'@ fundHIMN <- simStakesETS(mbase, .prCat = 'Hi', .setPrice = 'Mn', .initialFundSize = 1000)
#'@ saveRDS(fundHIMN, file = './data/fundHIMN.rds')

#'@ fundMNMN <- simStakesETS(mbase, .prCat = 'Mn', .setPrice = 'Mn', .initialFundSize = 1000)
#'@ saveRDS(fundMNMN, file = './data/fundMNMN.rds')

#'@ fundLOMN <- simStakesETS(mbase, .prCat = 'Lo', .setPrice = 'Mn', .initialFundSize = 1000)
#'@ saveRDS(fundLOMN, file = './data/fundLOMN.rds')

#'@ fundCLMN <- simStakesETS(mbase, .prCat = 'Cl', .setPrice = 'Mn', .initialFundSize = 1000)
#'@ saveRDS(fundCLMN, file = './data/fundCLMN.rds')


## settled with opening price.
#'@ fundOPLO <- simStakesETS(mbase, .prCat = 'Op', .setPrice = 'Lo', .initialFundSize = 1000)
#'@ saveRDS(fundOPLO, file = './data/fundOPLO.rds')

#'@ fundHILO <- simStakesETS(mbase, .prCat = 'Hi', .setPrice = 'Lo', .initialFundSize = 1000)
#'@ saveRDS(fundHILO, file = './data/fundHILO.rds')

#'@ fundMNLO <- simStakesETS(mbase, .prCat = 'Mn', .setPrice = 'Lo', .initialFundSize = 1000)
#'@ saveRDS(fundMNLO, file = './data/fundMNLO.rds')

#'@ fundLOLO <- simStakesETS(mbase, .prCat = 'Lo', .setPrice = 'Lo', .initialFundSize = 1000)
#'@ saveRDS(fundLOLO, file = './data/fundLOLO.rds')

#'@ fundCLLO <- simStakesETS(mbase, .prCat = 'Cl', .setPrice = 'Lo', .initialFundSize = 1000)
#'@ saveRDS(fundCLLO, file = './data/fundCLLO.rds')


## settled with closing price.
#'@ fundOPCL <- simStakesETS(mbase, .prCat = 'Op', .setPrice = 'Cl', .initialFundSize = 1000)
#'@ saveRDS(fundOPCL, file = './data/fundOPCL.rds')

#'@ fundHICL <- simStakesETS(mbase, .prCat = 'Hi', .setPrice = 'Cl', .initialFundSize = 1000)
#'@ saveRDS(fundHICL, file = './data/fundHICL.rds')

#'@ fundMNCL <- simStakesETS(mbase, .prCat = 'Mn', .setPrice = 'Cl', .initialFundSize = 1000)
#'@ saveRDS(fundMNCL, file = './data/fundMNCL.rds')

#'@ fundLOCL <- simStakesETS(mbase, .prCat = 'Lo', .setPrice = 'Cl', .initialFundSize = 1000)
#'@ saveRDS(fundLOCL, file = './data/fundLOCL.rds')

#'@ fundCLCL <- simStakesETS(mbase, .prCat = 'Cl', .setPrice = 'Cl', .initialFundSize = 1000)
#'@ saveRDS(fundCLCL, file = './data/fundCLCL.rds')

## Placed orders - Fund size without log
#'@ fundList <- list(fundOPHI = fundOPHI, fundHIHI = fundHIHI, fundMNHI = fundMNHI, fundLOHI = fundLOHI, fundCLHI = fundCLHI, 
#'@                 fundOPMN = fundOPMN, fundHIMN = fundHIMN, fundMNMN = fundMNMN, fundLOMN = fundLOMN, fundCLMN = fundCLMN, 
#'@                 fundOPLO = fundOPLO, fundHILO = fundHILO, fundMNLO = fundMNLO, fundLOLO = fundLOLO, fundCLLO = fundCLLO, 
#'@                 fundOPCL = fundOPCL, fundHICL = fundHICL, fundMNCL = fundMNCL, fundLOCL = fundLOCL, fundCLCL = fundCLCL)

#'@ ldply(fundList, function(x) { x %>% mutate(StartDate = first(Date), LatestDate = last(Date), InitFund = first(BR), LatestFund = last(Bal), Profit = sum(Profit), RR = LatestFund/InitFund) %>% dplyr::select(StartDate, LatestDate, InitFund, LatestFund, Profit, RR) %>% unique }) %>% tbl_df
## A tibble: 20 × 5
#        .id  StartDate LatestDate  InitFund LatestFund     Profit        RR
#      <chr>     <date>     <date>     <dbl>      <dbl>      <dbl>     <dbl>
#1  fundOPHI 2015-01-02 2017-01-20      1000  326.83685   1326.837  1.326837
#2  fundHIHI 2015-01-02 2017-01-20      1000    0.00000   1000.000  1.000000
#3  fundMNHI 2015-01-02 2017-01-20      1000  152.30210   1152.302  1.152302
#4  fundLOHI 2015-01-02 2017-01-20      1000  816.63808   1816.638  1.816638
#5  fundCLHI 2015-01-02 2017-01-20      1000  323.18564   1323.186  1.323186
#6  fundOPMN 2015-01-02 2017-01-20      1000  246.68001   1246.680  1.246680
#7  fundHIMN 2015-01-02 2017-01-20      1000  384.90915   1384.909  1.384909
#8  fundMNMN 2015-01-02 2017-01-20      1000    0.00000   1000.000  1.000000
#9  fundLOMN 2015-01-02 2017-01-20      1000  529.34170   1529.342  1.529342
#10 fundCLMN 2015-01-02 2017-01-20      1000  221.03926   1221.039  1.221039
#11 fundOPLO 2015-01-02 2017-01-20      1000  268.31155   1268.312  1.268312
#12 fundHILO 2015-01-02 2017-01-20      1000  649.35074   1649.351  1.649351
#13 fundMNLO 2015-01-02 2017-01-20      1000  298.28509   1298.285  1.298285
#14 fundLOLO 2015-01-02 2017-01-20      1000    0.00000   1000.000  1.000000
#15 fundCLLO 2015-01-02 2017-01-20      1000  208.85690   1208.857  1.208857
#16 fundOPCL 2015-01-02 2017-01-20      1000   30.55969   1030.560  1.030560
#17 fundHICL 2015-01-02 2017-01-20      1000  400.59057   1400.591  1.400591
#18 fundMNCL 2015-01-02 2017-01-20      1000  117.96808   1117.968  1.117968
#19 fundLOCL 2015-01-02 2017-01-20      1000  530.68975   1530.690  1.530690
#20 fundCLCL 2015-01-02 2017-01-20      1000    0.00000   1000.000  1.000000

## load fund files which is from chunk `r simStaking-woutLog`.
fundOPHI <- readRDS('./data/fundOPHI.rds')
fundHIHI <- readRDS('./data/fundHIHI.rds')
fundMNHI <- readRDS('./data/fundMNHI.rds')
fundLOHI <- readRDS('./data/fundLOHI.rds')
fundCLHI <- readRDS('./data/fundCLHI.rds')
fundOPMN <- readRDS('./data/fundOPMN.rds')
fundHIMN <- readRDS('./data/fundHIMN.rds')
fundMNMN <- readRDS('./data/fundMNMN.rds')
fundLOMN <- readRDS('./data/fundLOMN.rds')
fundCLMN <- readRDS('./data/fundCLMN.rds')
fundOPLO <- readRDS('./data/fundOPLO.rds')
fundHILO <- readRDS('./data/fundHILO.rds')
fundMNLO <- readRDS('./data/fundMNLO.rds')
fundLOLO <- readRDS('./data/fundLOLO.rds')
fundCLLO <- readRDS('./data/fundCLLO.rds')
fundOPCL <- readRDS('./data/fundOPCL.rds')
fundHICL <- readRDS('./data/fundHICL.rds')
fundMNCL <- readRDS('./data/fundMNCL.rds')
fundLOCL <- readRDS('./data/fundLOCL.rds')
fundCLCL <- readRDS('./data/fundCLCL.rds')

## Placed orders - Fund size without log
fundList <- list(fundOPHI = fundOPHI, fundHIHI = fundHIHI, fundMNHI = fundMNHI, fundLOHI = fundLOHI, fundCLHI = fundCLHI, 
                 fundOPMN = fundOPMN, fundHIMN = fundHIMN, fundMNMN = fundMNMN, fundLOMN = fundLOMN, fundCLMN = fundCLMN, 
                fundOPLO = fundOPLO, fundHILO = fundHILO, fundMNLO = fundMNLO, fundLOLO = fundLOLO, fundCLLO = fundCLLO, 
                fundOPCL = fundOPCL, fundHICL = fundHICL, fundMNCL = fundMNCL, fundLOCL = fundLOCL, fundCLCL = fundCLCL)
```

```{r simStaking-withLog, eval = FALSE, include = FALSE}
##============================ EVAL = FALSE ================================
## 
## Leveraged model 2
## 
## Placed orders - Fund size with log
fundOPHI <- simStakesETS(mbase, .prCat = 'Op', .setPrice = 'Hi', .initialFundSize = log(1000))
fundHIHI <- simStakesETS(mbase, .prCat = 'Hi', .setPrice = 'Hi', .initialFundSize = log(1000))
fundMNHI <- simStakesETS(mbase, .prCat = 'Mn', .setPrice = 'Hi', .initialFundSize = log(1000))
fundLOHI <- simStakesETS(mbase, .prCat = 'Lo', .setPrice = 'Hi', .initialFundSize = log(1000))
fundCLHI <- simStakesETS(mbase, .prCat = 'Cl', .setPrice = 'Hi', .initialFundSize = log(1000))

fundOPMN <- simStakesETS(mbase, .prCat = 'Op', .setPrice = 'Mn', .initialFundSize = log(1000))
fundHIMN <- simStakesETS(mbase, .prCat = 'Hi', .setPrice = 'Mn', .initialFundSize = log(1000))
fundMNMN <- simStakesETS(mbase, .prCat = 'Mn', .setPrice = 'Mn', .initialFundSize = log(1000))
fundLOMN <- simStakesETS(mbase, .prCat = 'Lo', .setPrice = 'Mn', .initialFundSize = log(1000))
fundCLMN <- simStakesETS(mbase, .prCat = 'Cl', .setPrice = 'Mn', .initialFundSize = log(1000))

fundOPLO <- simStakesETS(mbase, .prCat = 'Op', .setPrice = 'Lo', .initialFundSize = log(1000))
fundHILO <- simStakesETS(mbase, .prCat = 'Hi', .setPrice = 'Lo', .initialFundSize = log(1000))
fundMNLO <- simStakesETS(mbase, .prCat = 'Mn', .setPrice = 'Lo', .initialFundSize = log(1000))
fundLOLO <- simStakesETS(mbase, .prCat = 'Lo', .setPrice = 'Lo', .initialFundSize = log(1000))
fundCLLO <- simStakesETS(mbase, .prCat = 'Cl', .setPrice = 'Lo', .initialFundSize = log(1000))

fundOPCL <- simStakesETS(mbase, .prCat = 'Op', .setPrice = 'Cl', .initialFundSize = log(1000))
fundHICL <- simStakesETS(mbase, .prCat = 'Hi', .setPrice = 'Cl', .initialFundSize = log(1000))
fundMNCL <- simStakesETS(mbase, .prCat = 'Mn', .setPrice = 'Cl', .initialFundSize = log(1000))
fundLOCL <- simStakesETS(mbase, .prCat = 'Lo', .setPrice = 'Cl', .initialFundSize = log(1000))
fundCLCL <- simStakesETS(mbase, .prCat = 'Cl', .setPrice = 'Cl', .initialFundSize = log(1000))

## Placed orders - Fund size with log
#'@ fundList <- list(fundOPHI = fundOPHI, fundHIHI = fundHIHI, fundMNHI = fundMNHI, fundLOHI = fundLOHI, fundCLHI = fundCLHI, 
#'@                  fundOPMN = fundOPMN, fundHIMN = fundHIMN, fundMNMN = fundMNMN, fundLOMN = fundLOMN, fundCLMN = fundCLMN, 
#'@                  fundOPLO = fundOPLO, fundHILO = fundHILO, fundMNLO = fundMNLO, fundLOLO = fundLOLO, fundCLLO = fundCLLO, 
#'@                  fundOPCL = fundOPCL, fundHICL = fundHICL, fundMNCL = fundMNCL, fundLOCL = fundLOCL, fundCLCL = fundCLCL)
#'@ 
#'@ ldply(fundList, function(x) { x %>% mutate(StartDate = first(Date), LatestDate = last(Date), InitFund = first(BR), LatestFund = last(Bal), Profit = sum(Profit), RR = LatestFund/InitFund) %>% dplyr::select(StartDate, LatestDate, InitFund, LatestFund, Profit, RR) %>% unique }) %>% tbl_df

## A tibble: 20 × 7
#        .id  StartDate LatestDate InitFund LatestFund    Profit        RR
#      <chr>     <date>     <date>    <dbl>      <dbl>     <dbl>     <dbl>
#1  fundOPHI 2015-01-02 2017-01-20 6.907755 201.699419 194.79166 29.198982
#2  fundHIHI 2015-01-02 2017-01-20 6.907755   6.907755   0.00000  1.000000
#3  fundMNHI 2015-01-02 2017-01-20 6.907755  75.593102  68.68535 10.943222
#4  fundLOHI 2015-01-02 2017-01-20 6.907755 592.614380 585.70662 85.789718
#5  fundCLHI 2015-01-02 2017-01-20 6.907755 199.023237 192.11548 28.811565
#6  fundOPMN 2015-01-02 2017-01-20 6.907755 145.334081 138.42633 21.039263
#7  fundHIMN 2015-01-02 2017-01-20 6.907755 245.812470 238.90472 35.585000
#8  fundMNMN 2015-01-02 2017-01-20 6.907755   6.907755   0.00000  1.000000
#9  fundLOMN 2015-01-02 2017-01-20 6.907755 359.728088 352.82033 52.075975
#10 fundCLMN 2015-01-02 2017-01-20 6.907755 127.528193 120.62044 18.461597
#11 fundOPLO 2015-01-02 2017-01-20 6.907755 159.124291 152.21654 23.035600
#12 fundHILO 2015-01-02 2017-01-20 6.907755 452.725480 445.81772 65.538726
#13 fundMNLO 2015-01-02 2017-01-20 6.907755 180.580704 173.67295 26.141734
#14 fundLOLO 2015-01-02 2017-01-20 6.907755   6.907755   0.00000  1.000000
#15 fundCLLO 2015-01-02 2017-01-20 6.907755 117.219609 110.31185 16.969276
#16 fundOPCL 2015-01-02 2017-01-20 6.907755  17.669553  10.76180  2.557930
#17 fundHICL 2015-01-02 2017-01-20 6.907755 256.110890 249.20313 37.075849
#18 fundMNCL 2015-01-02 2017-01-20 6.907755  57.745913  50.83816  8.359577
#19 fundLOCL 2015-01-02 2017-01-20 6.907755 357.560612 350.65286 51.762200
#20 fundCLCL 2015-01-02 2017-01-20 6.907755   6.907755   0.00000  1.000000
```

```{r simStaking-woutLogLeverage, eval = FALSE, include = FALSE}
##============================ EVAL = FALSE ================================
## 
## Leveraged model 3
## 
## Due to the log(.initialfundSize) generates extremely high return compare to normal figure, I added a new parameter ".fundLeverageLog" which convert the normal fund size value into log into calculation and finally convert back to normal fund size figure."

## Placed orders - Fund size without log but exp() Leveraged.
#'@ fundOPHI <- simStakesETS(mbase, .prCat = 'Op', .setPrice = 'Hi', .initialFundSize = 1000, .fundLeverageLog = TRUE)
#'@ fundHIHI <- simStakesETS(mbase, .prCat = 'Hi', .setPrice = 'Hi', .initialFundSize = 1000, .fundLeverageLog = TRUE)
#'@ fundMNHI <- simStakesETS(mbase, .prCat = 'Mn', .setPrice = 'Hi', .initialFundSize = 1000, .fundLeverageLog = TRUE)
#'@ fundLOHI <- simStakesETS(mbase, .prCat = 'Lo', .setPrice = 'Hi', .initialFundSize = 1000, .fundLeverageLog = TRUE)
#'@ fundCLHI <- simStakesETS(mbase, .prCat = 'Cl', .setPrice = 'Hi', .initialFundSize = 1000, .fundLeverageLog = TRUE)

#'@ fundOPMN <- simStakesETS(mbase, .prCat = 'Op', .setPrice = 'Mn', .initialFundSize = 1000, .fundLeverageLog = TRUE)
#'@ fundHIMN <- simStakesETS(mbase, .prCat = 'Hi', .setPrice = 'Mn', .initialFundSize = 1000, .fundLeverageLog = TRUE)
#'@ fundMNMN <- simStakesETS(mbase, .prCat = 'Mn', .setPrice = 'Mn', .initialFundSize = 1000, .fundLeverageLog = TRUE)
#'@ fundLOMN <- simStakesETS(mbase, .prCat = 'Lo', .setPrice = 'Mn', .initialFundSize = 1000, .fundLeverageLog = TRUE)
#'@ fundCLMN <- simStakesETS(mbase, .prCat = 'Cl', .setPrice = 'Mn', .initialFundSize = 1000, .fundLeverageLog = TRUE)

#'@ fundOPLO <- simStakesETS(mbase, .prCat = 'Op', .setPrice = 'Lo', .initialFundSize = 1000, .fundLeverageLog = TRUE)
#'@ fundHILO <- simStakesETS(mbase, .prCat = 'Hi', .setPrice = 'Lo', .initialFundSize = 1000, .fundLeverageLog = TRUE)
#'@ fundMNLO <- simStakesETS(mbase, .prCat = 'Mn', .setPrice = 'Lo', .initialFundSize = 1000, .fundLeverageLog = TRUE)
#'@ fundLOLO <- simStakesETS(mbase, .prCat = 'Lo', .setPrice = 'Lo', .initialFundSize = 1000, .fundLeverageLog = TRUE)
#'@ fundCLLO <- simStakesETS(mbase, .prCat = 'Cl', .setPrice = 'Lo', .initialFundSize = 1000, .fundLeverageLog = TRUE)

#'@ fundOPCL <- simStakesETS(mbase, .prCat = 'Op', .setPrice = 'Cl', .initialFundSize = 1000, .fundLeverageLog = TRUE)
#'@ fundHICL <- simStakesETS(mbase, .prCat = 'Hi', .setPrice = 'Cl', .initialFundSize = 1000, .fundLeverageLog = TRUE)
#'@ fundMNCL <- simStakesETS(mbase, .prCat = 'Mn', .setPrice = 'Cl', .initialFundSize = 1000, .fundLeverageLog = TRUE)
#'@ fundLOCL <- simStakesETS(mbase, .prCat = 'Lo', .setPrice = 'Cl', .initialFundSize = 1000, .fundLeverageLog = TRUE)
#'@ fundCLCL <- simStakesETS(mbase, .prCat = 'Cl', .setPrice = 'Cl', .initialFundSize = 1000, .fundLeverageLog = TRUE)

## A tibble: 20 × 7
#        .id  StartDate LatestDate InitFund   LatestFund       Profit           RR
#       <chr>     <date>     <date>    <dbl>        <dbl>        <dbl>        <dbl>
# 1  fundOPHI 2015-01-02 2017-01-20     1000 2.096972e+27 7.701648e+03 2.096972e+24
# 2  fundHIHI 2015-01-02 2017-01-20     1000 2.718282e+00 5.350000e+02 2.718282e-03
# 3  fundMNHI 2015-01-02 2017-01-20     1000 3.900327e+04 1.064366e+03 3.900327e+01
# 4  fundLOHI 2015-01-02 2017-01-20     1000 2.718282e+00 9.620574e+09 2.718282e-03
# 5  fundCLHI 2015-01-02 2017-01-20     1000 6.689430e+23 6.611671e+03 6.689430e+20
# 6  fundOPMN 2015-01-02 2017-01-20     1000 2.454335e+01 1.027528e+03 2.454335e-02
# 7  fundHIMN 2015-01-02 2017-01-20     1000 2.718282e+00 2.628152e+03 2.718282e-03
# 8  fundMNMN 2015-01-02 2017-01-20     1000 2.718282e+00 5.350000e+02 2.718282e-03
# 9  fundLOMN 2015-01-02 2017-01-20     1000 2.718282e+00 3.916608e+04 2.718282e-03
# 10 fundCLMN 2015-01-02 2017-01-20     1000 1.585667e+01 9.900735e+02 1.585667e-02
# 11 fundOPLO 2015-01-02 2017-01-20     1000 1.152381e+00 3.455387e+03 1.152381e-03
# 12 fundHILO 2015-01-02 2017-01-20     1000 2.718282e+00 1.541190e+06 2.718282e-03
# 13 fundMNLO 2015-01-02 2017-01-20     1000 1.040560e+00 3.434093e+03 1.040560e-03
# 14 fundLOLO 2015-01-02 2017-01-20     1000 2.718282e+00 5.350000e+02 2.718282e-03
# 15 fundCLLO 2015-01-02 2017-01-20     1000 1.152544e+00 2.646148e+03 1.152544e-03
# 16 fundOPCL 2015-01-02 2017-01-20     1000 2.919029e+00 5.465890e+02 2.919029e-03
# 17 fundHICL 2015-01-02 2017-01-20     1000 2.718282e+00 2.278748e+05 2.718282e-03
# 18 fundMNCL 2015-01-02 2017-01-20     1000 1.034658e+01 9.680842e+02 1.034658e-02
# 19 fundLOCL 2015-01-02 2017-01-20     1000 2.718282e+00 2.407137e+08 2.718282e-03
# 20 fundCLCL 2015-01-02 2017-01-20     1000 2.718282e+00 5.350000e+02 2.718282e-03

##============================ EVAL = FALSE ================================
## Profit and Loss of single model (write in list format).
#'@ cbind(
#'@   OP = df.op %>% dplyr::select(Return.Back, Return.Lay) %>% colSums %>% data.frame, 
#'@   HI = df.hi %>% dplyr::select(Return.Back, Return.Lay) %>% colSums %>% data.frame, 
#'@   MN = df.mn %>% dplyr::select(Return.Back, Return.Lay) %>% colSums %>% data.frame, 
#'@   LO = df.lo %>% dplyr::select(Return.Back, Return.Lay) %>% colSums %>% data.frame, 
#'@   CL = df.cl %>% dplyr::select(Return.Back, Return.Lay) %>% colSums %>% data.frame)

## Placed orders - Fund size with log
fundList <- list(fundOPHI = fundOPHI, fundHIHI = fundHIHI, fundMNHI = fundMNHI, fundLOHI = fundLOHI, fundCLHI = fundCLHI, 
                 fundOPMN = fundOPMN, fundHIMN = fundHIMN, fundMNMN = fundMNMN, fundLOMN = fundLOMN, fundCLMN = fundCLMN, 
                 fundOPLO = fundOPLO, fundHILO = fundHILO, fundMNLO = fundMNLO, fundLOLO = fundLOLO, fundCLLO = fundCLLO, 
                 fundOPCL = fundOPCL, fundHICL = fundHICL, fundMNCL = fundMNCL, fundLOCL = fundLOCL, fundCLCL = fundCLCL)

## Summary of ROI
ldply(fundList, function(x) { x %>% mutate(StartDate = xts::first(Date), LatestDate = last(Date), InitFund = xts::first(BR), LatestFund = last(Bal), Profit = sum(Profit), RR = LatestFund/InitFund) %>% dplyr::select(StartDate, LatestDate, InitFund, LatestFund, Profit, RR) %>% unique }) %>% tbl_df
## A tibble: 20 × 7
#        .id  StartDate LatestDate InitFund   LatestFund       Profit           RR
#       <chr>     <date>     <date>    <dbl>        <dbl>        <dbl>        <dbl>
# 1  fundOPHI 2015-01-02 2017-01-20     1000 2.096972e+27 7.701648e+03 2.096972e+24
# 2  fundHIHI 2015-01-02 2017-01-20     1000 2.718282e+00 5.350000e+02 2.718282e-03
# 3  fundMNHI 2015-01-02 2017-01-20     1000 3.900327e+04 1.064366e+03 3.900327e+01
# 4  fundLOHI 2015-01-02 2017-01-20     1000 2.718282e+00 9.620574e+09 2.718282e-03
# 5  fundCLHI 2015-01-02 2017-01-20     1000 6.689430e+23 6.611671e+03 6.689430e+20
# 6  fundOPMN 2015-01-02 2017-01-20     1000 2.454335e+01 1.027528e+03 2.454335e-02
# 7  fundHIMN 2015-01-02 2017-01-20     1000 2.718282e+00 2.628152e+03 2.718282e-03
# 8  fundMNMN 2015-01-02 2017-01-20     1000 2.718282e+00 5.350000e+02 2.718282e-03
# 9  fundLOMN 2015-01-02 2017-01-20     1000 2.718282e+00 3.916608e+04 2.718282e-03
# 10 fundCLMN 2015-01-02 2017-01-20     1000 1.585667e+01 9.900735e+02 1.585667e-02
# 11 fundOPLO 2015-01-02 2017-01-20     1000 1.152381e+00 3.455387e+03 1.152381e-03
# 12 fundHILO 2015-01-02 2017-01-20     1000 2.718282e+00 1.541190e+06 2.718282e-03
# 13 fundMNLO 2015-01-02 2017-01-20     1000 1.040560e+00 3.434093e+03 1.040560e-03
# 14 fundLOLO 2015-01-02 2017-01-20     1000 2.718282e+00 5.350000e+02 2.718282e-03
# 15 fundCLLO 2015-01-02 2017-01-20     1000 1.152544e+00 2.646148e+03 1.152544e-03
# 16 fundOPCL 2015-01-02 2017-01-20     1000 2.919029e+00 5.465890e+02 2.919029e-03
# 17 fundHICL 2015-01-02 2017-01-20     1000 2.718282e+00 2.278748e+05 2.718282e-03
# 18 fundMNCL 2015-01-02 2017-01-20     1000 1.034658e+01 9.680842e+02 1.034658e-02
# 19 fundLOCL 2015-01-02 2017-01-20     1000 2.718282e+00 2.407137e+08 2.718282e-03
# 20 fundCLCL 2015-01-02 2017-01-20     1000 2.718282e+00 5.350000e+02 2.718282e-03

## Details of ROI
llply(fundList, function(x) x[c('BR', 'fB', 'fS', 'EUB', 'EUS', 'Edge', 'PF', 'FC', 'Buy', 'Sell', 'BuyS', 'SellS', 'Profit', 'Bal', 'RR')] %>% dplyr::filter(PF >0 | FC > 0))
```


```{r simStakingG-woutLog, eval = FALSE, include = FALSE}
##============================ EVAL = FALSE ================================
## 
## Garch Model 1 without leverage.
## 
## Placed orders - Fund size with log

#'@ mbase <- USDJPY

## settled with highest price.
fundGMOPHI <- simStakesGarch(mbase, .prCat = 'Op', .setPrice = 'Hi', .initialFundSize = 1000)
saveRDS(fundGMOPHI, file = './data/fundGMOPHI.rds')

fundGMHIHI <- simStakesGarch(mbase, .prCat = 'Hi', .setPrice = 'Hi', .initialFundSize = 1000)
saveRDS(fundGMHIHI, file = './data/fundGMHIHI.rds')

fundGMMNHI <- simStakesGarch(mbase, .prCat = 'Mn', .setPrice = 'Hi', .initialFundSize = 1000)
saveRDS(fundGMMNHI, file = './data/fundGMMNHI.rds')

fundGMLOHI <- simStakesGarch(mbase, .prCat = 'Lo', .setPrice = 'Hi', .initialFundSize = 1000)
saveRDS(fundGMLOHI, file = './data/fundGMLOHI.rds')

fundGMCLHI <- simStakesGarch(mbase, .prCat = 'Cl', .setPrice = 'Hi', .initialFundSize = 1000)
saveRDS(fundGMCLHI, file = './data/fundGMCLHI.rds')


## settled with mean price.
fundGMOPMN <- simStakesGarch(mbase, .prCat = 'Op', .setPrice = 'Mn', .initialFundSize = 1000)
saveRDS(fundGMOPMN, file = './data/fundGMOPMN.rds')

fundGMHIMN <- simStakesGarch(mbase, .prCat = 'Hi', .setPrice = 'Mn', .initialFundSize = 1000)
saveRDS(fundGMHIMN, file = './data/fundGMHIMN.rds')

fundGMMNMN <- simStakesGarch(mbase, .prCat = 'Mn', .setPrice = 'Mn', .initialFundSize = 1000)
saveRDS(fundGMMNMN, file = './data/fundGMMNMN.rds')

fundGMLOMN <- simStakesGarch(mbase, .prCat = 'Lo', .setPrice = 'Mn', .initialFundSize = 1000)
saveRDS(fundGMLOMN, file = './data/fundGMLOMN.rds')

fundGMCLMN <- simStakesGarch(mbase, .prCat = 'Cl', .setPrice = 'Mn', .initialFundSize = 1000); saveRDS(fundGMCLMN, file = './data/fundGMCLMN.rds')


## settled with lowest price.
fundGMOPLO <- simStakesGarch(mbase, .prCat = 'Op', .setPrice = 'Lo', .initialFundSize = 1000)
saveRDS(fundGMOPLO, file = './data/fundGMOPLO.rds')

fundGMHILO <- simStakesGarch(mbase, .prCat = 'Hi', .setPrice = 'Lo', .initialFundSize = 1000)
saveRDS(fundGMHILO, file = './data/fundGMHILO.rds')

fundGMMNLO <- simStakesGarch(mbase, .prCat = 'Mn', .setPrice = 'Lo', .initialFundSize = 1000)
saveRDS(fundGMMNLO, file = './data/fundGMMNLO.rds')

fundGMLOLO <- simStakesGarch(mbase, .prCat = 'Lo', .setPrice = 'Lo', .initialFundSize = 1000)
saveRDS(fundGMLOLO, file = './data/fundGMLOLO.rds')


## settled with closing price.
fundGMCLLO <- simStakesGarch(mbase, .prCat = 'Cl', .setPrice = 'Lo', .initialFundSize = 1000)
saveRDS(fundGMCLLO, file = './data/fundGMCLLO.rds')

fundGMOPCL <- simStakesGarch(mbase, .prCat = 'Op', .setPrice = 'Cl', .initialFundSize = 1000)
saveRDS(fundGMOPCL, file = './data/fundGMOPCL.rds')

fundGMHICL <- simStakesGarch(mbase, .prCat = 'Hi', .setPrice = 'Cl', .initialFundSize = 1000)
saveRDS(fundGMHICL, file = './data/fundGMHICL.rds')

fundGMMNCL <- simStakesGarch(mbase, .prCat = 'Mn', .setPrice = 'Cl', .initialFundSize = 1000)
saveRDS(fundGMMNCL, file = './data/fundGMMNCL.rds')

fundGMLOCL <- simStakesGarch(mbase, .prCat = 'Lo', .setPrice = 'Cl', .initialFundSize = 1000)
saveRDS(fundGMLOCL, file = './data/fundGMLOCL.rds')

fundGMCLCL <- simStakesGarch(mbase, .prCat = 'Cl', .setPrice = 'Cl', .initialFundSize = 1000)
saveRDS(fundGMCLCL, file = './data/fundGMCLCL.rds')

## Placed orders - Fund size without log
fundGMList <- list(fundOPHI = fundGMOPHI, fundHIHI = fundGMHIHI, fundMNHI = fundGMMNHI, fundLOHI = fundGMLOHI, fundCLHI = fundGMCLHI, 
                fundOPMN = fundGMOPMN, fundHIMN = fundGMHIMN, fundGMMNMN = fundGMMNMN, fundLOMN = fundGMLOMN, fundCLMN = fundGMCLMN, 
                fundOPLO = fundGMOPLO, fundHILO = fundGMHILO, fundMNLO = fundGMMNLO, fundLOLO = fundGMLOLO, fundCLLO = fundGMCLLO, 
                fundOPCL = fundGMOPCL, fundHICL = fundGMHICL, fundMNCL = fundGMMNCL, fundLOCL = fundGMLOCL, fundCLCL = fundGMCLCL)

ldply(fundGMList, function(x) { x %>% mutate(StartDate = first(Date), LatestDate = last(Date), InitFund = first(BR), LatestFund = last(Bal), Profit = sum(Profit), RR = LatestFund/InitFund) %>% dplyr::select(StartDate, LatestDate, InitFund, LatestFund, Profit, RR) %>% unique }) %>% tbl_df
## # A tibble: 20 x 7
#          .id  StartDate LatestDate InitFund LatestFund       Profit       RR
#        <chr>     <date>     <date>    <dbl>      <dbl>        <dbl>    <dbl>
# 1   fundOPHI 2015-01-02 2017-01-20     1000   1344.257 3.442572e+02 1.344257
# 2   fundHIHI 2015-01-02 2017-01-20     1000   1000.006 5.815563e-03 1.000006
# 3   fundMNHI 2015-01-02 2017-01-20     1000   1185.847 1.858470e+02 1.185847
# 4   fundLOHI 2015-01-02 2017-01-20     1000   1770.291 7.702907e+02 1.770291
# 5   fundCLHI 2015-01-02 2017-01-20     1000   1362.749 3.627491e+02 1.362749
# 6   fundOPMN 2015-01-02 2017-01-20     1000   1266.433 2.664327e+02 1.266433
# 7   fundHIMN 2015-01-02 2017-01-20     1000   1392.315 3.923148e+02 1.392315
# 8 fundGMMNMN 2015-01-02 2017-01-20     1000   1000.000 3.088960e-06 1.000000
# 9   fundLOMN 2015-01-02 2017-01-20     1000   1443.834 4.438342e+02 1.443834
#10   fundCLMN 2015-01-02 2017-01-20     1000   1266.810 2.668104e+02 1.266810
#11   fundOPLO 2015-01-02 2017-01-20     1000   1298.491 2.984907e+02 1.298491
#12   fundHILO 2015-01-02 2017-01-20     1000   1713.915 7.139146e+02 1.713915
#13   fundMNLO 2015-01-02 2017-01-20     1000   1245.405 2.454050e+02 1.245405
#14   fundLOLO 2015-01-02 2017-01-20     1000   1000.000 0.000000e+00 1.000000
#15   fundCLLO 2015-01-02 2017-01-20     1000   1258.850 2.588497e+02 1.258850
#16   fundOPCL 2015-01-02 2017-01-20     1000   1031.448 3.144812e+01 1.031448
#17   fundHICL 2015-01-02 2017-01-20     1000   1453.842 4.538417e+02 1.453842
#18   fundMNCL 2015-01-02 2017-01-20     1000   1090.863 9.086251e+01 1.090863
#19   fundLOCL 2015-01-02 2017-01-20     1000   1507.365 5.073648e+02 1.507365
#20   fundCLCL 2015-01-02 2017-01-20     1000   1000.000 1.020225e-06 1.000000
```


```{r roi-ets, echo = FALSE, eval = FALSE}
## plot html table
##============================ EVAL = FALSE ================================
tagList(
  tags$div(align = "center", 
           class = "bg-info", 
           tags$h3(class = "bg-primary", "Profit and Loss of Investment (2015-Jan-02 2017-Jan-20)"), 
           tags$h5(align = "center", class = "text-muted", 
                   "Error-Trend-Seasonal or ExponenTial Smoothing Models")), 
  as.htmlwidget(ets.tbl %>% formattable(list(
    
    LatestFund = formatter('span', style = x ~ formattable::style(color = ifelse(rank(-x) <= 3, 'blue', 'grey')), x ~ paste0(round(x, 2), ' (rank: ', sprintf('%02f', rank(-x)), ')')), 
    
    Profit = formatter('span', style = x ~ formattable::style(color = ifelse(rank(-x) <= 3, 'blue', 'grey')), x ~ paste0(round(x, 2), ' (rank: ', sprintf('%02f', rank(-x)), ')')), 
    
    RR = formatter('span', style = x ~ formattable::style(color = ifelse(rank(-x) <= 3, 'blue', 'grey')), x ~ sprintf('%1.2f%% (rank: %.0f)', 100 * x, rank(-x)))))))
```

```{r plot-varAutoArima, echo = FALSE, results = 'asis'}
## Betting strategy 1 - Normal range betting
## Plot the ROI of investment fund.
plotAutoArima <- data.frame(varB1['Date'], varB1[grep('Bal', names(varB1))])
LineAutoArima <-  gvisLineChart(plotAutoArima, 'Date', names(plotAutoArima)[-1],
                        options = list(title = 'Auto Arima Models', 
                                       gvis.editor = 'Edit me!'))
plot(LineAutoArima)
```

# 6. Conclusion



```{r stopPar, echo = FALSE}
## Set options back to original options
options(op)
options(warn = 0)
#'@ stopCluster(cl)
```

# 7. Appendix

## 7.1 Documenting File Creation 

  It's useful to record some information about how your file was created.

  - File creation date: 2018-07-13
  - File latest updated date: `r today('Asia/Tokyo')`
  - `r R.version.string`
  - R version (short form): `r getRversion()`
  - [<span style='color:blue'>**rmarkdown** package</span>](https://github.com/rstudio/rmarkdown) version: `r packageVersion('rmarkdown')`
  - [<span style='color:blue'>**tufte** package</span>](https://github.com/rstudio/tufte) version: `r packageVersion('tufte')`
  - File version: 1.0.1
  - Author Profile: [<span style='color:blue'>®γσ, Eng Lian Hu</span>](https://beta.rstudioconnect.com/englianhu/ryo-eng/)
  - GitHub: [<span style='color:blue'>Source Code</span>](https://github.com/englianhu/binary.com-interview-question)
  - Additional session information
  
```{r info, echo = FALSE, warning = FALSE, results = 'asis'}
suppressMessages(require('dplyr', quietly = TRUE))
suppressMessages(require('formattable', quietly = TRUE))

lubridate::now('Asia/Tokyo')
sys1 <- devtools::session_info()$platform %>% unlist %>% data.frame(Category = names(.), session_info = .)
rownames(sys1) <- NULL
sys1 %>% formattable %>% as.htmlwidget

data.frame(Sys.info()) %>% mutate(Category = rownames(.)) %>% .[2:1] %>% rename(Category = Category, Sys.info =  Sys.info..) %>% formattable %>% as.htmlwidget

rm(sys1)
```

## 7.2 Reference

  01. [<span style='color:blue'>Quant Strategies HFT</span>](https://github.com/englianhu/Quant-Strategies-HFT)
  02. [<span style='color:blue'>Real Time FXCM</span>](https://github.com/scibrokes/real-time-fxcm)<img src='https://raw.githubusercontent.com/englianhu/binary.com-interview-question/master/www/hot.jpg?raw=true' width='20'>
  03. [<span style='color:blue'>Real Time Trading System (Trial)</span>](https://beta.rstudioconnect.com/content/3775/)<img src='https://raw.githubusercontent.com/englianhu/binary.com-interview-question/master/www/hot.jpg?raw=true' width='20'>

**Powered by - Copyright® Intellectual Property Rights of <img src='https://raw.githubusercontent.com/englianhu/binary.com-interview-question/master/www/oda-army2.jpg?raw=true' width='24'> [<span style='color:blue'>Scibrokes®</span>](http://www.scibrokes.com)個人の経営企業**
